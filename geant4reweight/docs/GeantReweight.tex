\setlength{\headheight}{15pt}
\documentclass[12pt]{article}
\usepackage{fancyhdr}
\lhead{}
\chead{}
\rhead{}
\renewcommand{\headrulewidth}{0pt}
\pagestyle{fancy}
\usepackage{graphicx}
\usepackage[top=2cm,bottom=3cm]{geometry}
\usepackage[svgnames]{xcolor}
\usepackage[colorlinks=true,linkcolor=DarkBlue,citecolor=DarkBlue]{hyperref}
\usepackage{xspace}
\usepackage{rotating}
\usepackage{units}
%\usepackage{subfig}
%\usepackage{amssymb, amsmath}
\usepackage{amsmath}
\usepackage{authblk}
\usepackage{lineno}
\usepackage{listings} 
\usepackage[normalem]{ulem}
\usepackage{adjustbox}
%\usepackage{placeins}
\usepackage[section]{placeins}
\usepackage{qtree}
\usepackage{SIunits}
\usepackage{hepunits}
\usepackage{hepparticles}
\usepackage{cancel}
\usepackage{hepnames}
\usepackage{epstopdf}
\usepackage{mathtools}
\usepackage{caption}
\usepackage[aboveskip=-10pt]{subcaption}
\usepackage[capitalise]{cleveref}
\usepackage{braket}
\usepackage{slashed}
\usepackage{subfiles}
\usepackage{graphicx}
\usepackage{textcomp}
\newcommand{\textapprox}{\raisebox{0.5ex}{\texttildelow}}

\newcommand{\todo}[1]{{\color{red} TODO: #1}}
\newcommand\red[1]{{\color{red}#1}}
\newcommand{\ccpi}{CC1$\pi^0$\xspace}
\newcommand{\ccpis}{CC$\pi^0$\xspace}
\newcommand{\ccpip}{CC1$\pi^+$\xspace}
\newcommand{\ncpi}{NC1$\pi^0$\xspace}
\newcommand{\ccqe}{CCQE\xspace}
\newcommand{\mares}{\ensuremath{M_A^\mathrm{res}}\xspace}
\newcommand{\ppi}{\ensuremath{|\mathbf{p}_{\pi^0}|}\xspace}
\newcommand{\mb}{MiniBooNE\xspace}
\newcommand{\minerva}{MINER\ensuremath{\nu}A\xspace}
\newcommand{\neut}{\textsc{neut}\xspace}
\newcommand{\nuance}{\textsc{nuance}\xspace}
\newcommand{\tmu}{\ensuremath{T_{\mu}}\xspace}
\newcommand{\pmu}{\ensuremath{|\textbf{p}_{\mu}|}\xspace}
\newcommand{\cost}{\ensuremath{\cos{\theta_{\mu}}}\xspace}
\newcommand{\enu}{\ensuremath{E_{\nu}}\xspace}
\newcommand{\qq}{\ensuremath{Q^{2}}\xspace}
\newcommand{\qqqe}{\ensuremath{Q^{2}_{\textrm{QE}}}\xspace}
\newcommand{\pf}{\ensuremath{p_{F}}\xspace}
\newcommand{\eb}{\ensuremath{E_{b}}\xspace}
\newcommand{\carb}{C\ensuremath{^{12}}\xspace}
\newcommand{\oxy}{O\ensuremath{^{16}}\xspace}
\newcommand{\ie}{i.e.\xspace}
\newcommand{\eg}{e.g.\xspace}
\newcommand{\ma}{\ensuremath{M_{\textrm{A}}}\xspace}
\newcommand{\maqe}{\ensuremath{M_{\textrm{A}}^{\textrm{QE}}}\xspace}
\newcommand{\numu}{\Pnum}
\newcommand{\nue}{\Pnue}
\newcommand{\numubar}{\APnum}
\newcommand{\nuebar}{\APnue}
\newcommand{\enuqerfg}{\ensuremath{E^{\nu}_{\textrm{QE,RFG}}}\xspace}
\newcommand{\enuqe}{\ensuremath{E^{\nu}_{\textrm{QE}}}\xspace}
\newcommand{\chisq}{\ensuremath{\chi^{2}}\xspace}
\newcommand{\chisqmin}{\ensuremath{\chi^{2}_{\textrm{min}}}\xspace}
\newcommand{\chtwo}{CH\ensuremath{_{2}}\xspace}
\newcommand{\wroclaw}{Wroc{\l}aw\xspace}
\newcommand{\km}{\kilo\meter\xspace}
\newcommand{\m}{\meter\xspace}
\newcommand{\evsq}{\eV\ensuremath{^{2}}\xspace}
\newcommand{\POD}{P{\O}D\xspace}
\newcommand{\ecal}{ECal\xspace}
\newcommand{\ecals}{ECals\xspace}
\newcommand{\dsecal}{Ds-ECal\xspace}
\newcommand{\vol}[4]{\ensuremath{#1\times#2\times\unit{#3}{#4}}\xspace}
\newcommand{\area}[3]{\ensuremath{#1\times\unit{#2}{#3}}\xspace}
\newcommand{\pizero}{\pi^{0}\xspace}
\newcommand{\kg}{\kilo\gram\xspace}
\newcommand{\lep}{\ell}
\newcommand{\mnn}{multi-nucleon--neutrino\xspace}
\newcommand{\elt}{\ensuremath{E_{<}}\xspace}
\newcommand{\egt}{\ensuremath{E_{>}}\xspace}


\renewcommand\Im{\operatorname{Im}}

\graphicspath{{figures/}}

\newif\ifpdf
\ifx\pdfoutput\undefined
   \pdffalse
\else
   \pdfoutput=1
   \pdftrue
\fi
\ifpdf
   \usepackage{graphicx}
   \usepackage{epstopdf}
   %\DeclareGraphicsRule{.eps}{pdf}{.pdf}{`epstopdf #1}
   \pdfcompresslevel=9
\else
   \usepackage{graphicx}
\fi

\graphicspath{{figs/}}


\lstset{
  backgroundcolor=\color{lightgray},
  breaklines=true,
  basicstyle=\ttfamily,
%  columns=fullflexible
}


\title{GeantReweight \\ 
   \large A Framework for Pion Scattering Reweighting}

\date{}
\begin{document}


\author[1]{Jake Calcutt}
\author[2]{Laura Fields}
\author[1]{Kendall Mahn}
\affil[1]{Michigan State University}
\affil[2]{Fermi National Accelerator Laboratory}

\maketitle
\thispagestyle{fancy}
%\linenumbers
%\begin{abstract}

\section{Motivation}
Errors in neutrino energy estimation serve as large sources of systematic uncertainty in modern neutrino oscillation experiments such as the Deep Underground Neutrino Experiment (DUNE). This estimation relies on the reconstruction of particles, such as pions, produced at the macroscopic neutrino interaction vertex. As the pions travel through the DUNE detector, they possibly undergo secondary interactions within the detector. This allows for misreconstruction and thus errors in the neutrino energy estimation.  It is then crucial to understand the rate of these interactions - the pion interaction cross section - to account for this misreconstruction and misestimation. 

For DUNE, whose detection medium is Liquid Argon, it is important to understand uncertainties on these interactions with respect to data. Upcoming results from the LArIAT and ProtoDUNE experiments will increase our knowledge of these interactions on Argon, where there is currently limited data. We must also be able to estimate the uncertainty on model predictions used within neutrino detector simulations. The Geant4 software package provides this simulation, but currently has no way of providing an estimation of the uncertainty on its prediction\footnote{There is currently no way for users to easily vary the cross section model short of changing the hard-coded cross section tables by hand.}. This document describes a framework by which one can vary Geant4's pion-nucleus cross section predictions in order to fit to data (estimating uncertainties), reweight pions simulated by Geant4 to some variation of the cross section prediction, and to propagate the cross section uncertainties using the reweighting. 

\section{Pion Interactions}
As pions travel through the detector, they can undergo discrete interactions with the nuclei of the detector components. These interactions can largely be separated into elastic scattering, in which the nucleus is left in its ground state, and various reactive/inelastic scattering channels. These can be described by their final states as in Table \ref{tab:fates}. Additionally, in these reactive interaction channels, any number of nucleons (or none) could be knocked out of the nucleus. 

\begin{table}
\begin{center}
  \begin{tabular}{| c | l |}
  \hline
  \textbf{Channel} & \multicolumn{1}{|c|}{\textbf{Definition}}   \\  
  \hline
  \hline	
  Inelastic/Quasielastic & $\pi^{\pm} + N \rightarrow \pi'^{\pm} + N'$ \\
  \hline 
  Absorption & $\pi^{\pm} + N \rightarrow N'$ \\
  \hline
  Single Charge Exchange & $\pi^{\pm} + N \rightarrow \pi^{0} + N'$ \\
  \hline
  Double Charge Exchange & $\pi^{\pm} + N \rightarrow \pi^{\mp} + N'$ \\
  \hline
  Pion Production & $\pi^{\pm} + N \rightarrow n\pi + N'$ \\
  \hline
  \end{tabular}
\end{center}
\caption{Reactive Pion-Nucleus Interactions\label{tab:fates}}
\end{table}

\section{Geant4 Simulation}
Before describing the reweighting process, it is important to understand the way Geant4 handles simulating particles within matter. A user defines the material content and shape of the tracking/detector region, the initial particles to be simulated within the detector, and the set of active physics processes that will be used within the simulation. 

During the simulation, a particle takes a series of steps throughout the detector until it is either removed from the simulation stack by some physics process (decaying, certain interactions) or by leaving the volume. During each step, processes are invoked algorithmically. The processes that describe pion interactions - both elastic and inelastic - are chosen to occur based on their interaction cross sections. Figure \ref{fig:xsecs} shows the $\pi^+ - $ Carbon inelastic and elastic cross sections.

\begin{figure}[htpb]
	\centering
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Demonstration/xsecs}.pdf}
	\end{subfigure}
	\caption{$\pi^+$ -- Carbon Inelastic and Elastic Cross Sections. Extracted from Geant4 version 10.3.p03d}\label{fig:xsecs}
\end{figure}	

When an inelastic interaction occurs, Geant4 then invokes a specific model (as chosen by the user). In general, Geant4 models handle the specifics of the changes of particles (which are added or removed from the simulation stack), as well as changes in particle kinematics. The most widely-used model used for inelastic hadronic interactions is the Bertini Cascade. In this model, the hadron enters into a nucleus, and it takes a series of steps. At each step, it has a chance of interacting with nucleons. When it does, any resulting particles are added to the stack and allowed to further propagate through the medium. This cascading behavior goes on until all particles are either ejected from the nucleus or are absorbed. 

\section{Weighting Scheme}
This section describes the way weights are assigned to simulated tracks. The weights are used when binning observables of the interaction in order to approximate the results of the simulation under some other model assumption.

Weights will be assigned to an entire track\footnote{Each track receives separate weights from varying the inelastic and elastic cross sections. The same weights are applied to each step within the track.}, and according to whether inelastic or elastic scatters occur along a track. There will be some divergence in the treatment of inelastic and elastic weights due to the fact that inelastic scatters removes the track from the simulation stack\footnote{When an inelastic interaction is chosen to occur, the corresponding physics model is invoked as described above. The initial pion track is terminated. Then, depending on what exits the nucleus as a result of the cascade, a new set of hadrons is created and tracked throughout the macroscopic volume of the simulation.} while elastic scatters do not. 

\subsection{Inelastic Interaction 
Weights}\label{subsec:inel_weights}

Consider a pion travelling through some material with an Inelastic interaction cross section $\sigma$. It has a probability of travelling some small distance, $\delta x$, without undergoing an interaction\footnote{Normally, the number density of the material is stated in this equation, but is baked into the cross section here. Thus, the cross sections discussed here will depend on the surrounding material.}:
%\begin{equation}\label{eq:Psurv}
%P_{Surv} = e^{- \sigma \delta x} \simeq (1 - \sigma \delta x)
%\end{equation}
\begin{equation}\label{eq:Psurv}
P_{Surv} = e^{- \sigma \delta x}
\end{equation}
Accordingly, it has a chance for interacting along that distance:
%\begin{equation}\label{eq:Pint}
%P_{Int} = \sigma \delta x
%\end{equation}
\begin{equation}\label{eq:Pint}
P_{Int} = 1 - e^{- \sigma \delta x}
\end{equation}
Within Geant4, the pion takes a series steps before the track is terminated. This termination will occur in the following cases:
\begin{enumerate}
\item The pion undergoes an Inelastic interaction
\item It exits the tracking volume
\item It decays in flight
\item It stops within the tracking volume and either decays or is captured
\end{enumerate}
In the context of reweighting the Inelastic cross section, everything but the top case will be considered a surviving track.
Each step will occur with a probability of the form of Equation \ref{eq:Psurv}, giving the following as the total probability for the pion to travel along the entire track without engaging in an Inelastic interaction:
\begin{equation}
P_{Track} =  e^{- \sum \limits_{i = 1}^{N} \sigma_i L_i}
\end{equation} 
where $\sigma_i$\footnote{Note that the cross section depends on the pion momentum and the surrounding material at each step. The subscript $i$ reflects this.} and $L_i$ are the Inelastic cross section and the length of the step taken for a given step $i$, and the sum in the exponential is over the $N$ steps of the track.

Thus, for a varied cross section model, a track which does not undergo an Inelastic interaction receives the following weight:
\begin{equation}\label{eq:surv_weight}
  W_{surv} = \frac{e^{- \sum \limits_{i=1}^{N} \sigma'_i L_i}}{e^{- \sum \limits_{i=1}^{N} \sigma_i L_i}}
\end{equation}
Here, $\sigma'_i$ represents the varied set of Inelastic cross sections depending on the surrounding material and pion momentum at each step.

For tracks that end in an Inelastic interaction, the last step $N$ will receive a factor of the form of Equation \ref{eq:Pint}. Thus, the track will receive the following weight: 
\begin{equation}\label{eq:int_weight}
  W_{int} = \Bigg( \frac{1 - e^{-\sigma'_{N}L_N}}{1 - e^{-\sigma_{N}L_N}} \Bigg) 
\Bigg( \frac{e^{- \sum \limits_{i=1}^{N-1} \sigma'_i L_i}}{e^{- \sum \limits_{i=1}^{N-1} \sigma_i L_i}} \Bigg)
\end{equation}
Where the sums in second term leaves out the last step $N$. 

\subsection{Elastic Interaction Weights}
As mentioned before, the track is not terminated when elastic scatters occur. This has two effects on the weigthing scheme:
\begin{enumerate}
\item The weight is calculated independently of inelastic scatters
\item The track can have multiple elastic scatters before termination, each with associated weighting factors. 
\end{enumerate}

Because a track will never end in an elastic scatter\footnote{Elastic hadronic interactions only result in changes of kinematics but never a change in particles or a stopping of the hadron.}, the weight will always contain a term in the form of Equation \ref{eq:surv_weight}. If no elastic scatter occurs, the steps included in the sum span the entire track. For any other number of elastic scatters, those steps span to the end of the track from the step immediately after the last elastic scatter. This accounts for the fact that an elastic scatter did not occur in that range. 

In addition to this factor, multiple weights are assigned from the start of the track to the first elastic scatter and then between any subsequent elastic scatters. These take a similar form to Equation \ref{eq:int_weight}.

The resulting weight then takes the form of:
\begin{equation}\label{ref:elastFull}
W_{elast} = \Bigg( \prod \limits_{e} \frac{\sigma_{e}'}{\sigma_{e}} \frac{\exp(-\sum \limits_i^{e-1} L_i  \sigma_{i}')}{\exp(-\sum \limits_i^{e-1} L_i  \sigma_{i})} \Bigg)
\Bigg( \frac{\exp(-\sum \limits_j^{end} L_j \sigma_{j}')} {\exp(-\sum \limits_j^{end} L_j \sigma_{j})} \Bigg)
\end{equation}
Here, all $\sigma$ are the elastic scattering cross section depending on surrounding material and pion momentum at the denoted step. The product in the first term runs over all of the elastic scatters throughout the track. The sums in the first term run from either the first step in the track or the first step after each scatter $e$. The sums in the second term run from the step after the last elastic scatter to the end of the track.

\subsection{Reweighting Final States}\label{subsec:fs_rw}
The exclusive channels\footnote{The definitions of these can be found in Table \ref{tab:fates}} of inelastic scattering can also be reweighted. This is done by characterizing the final state of an inelastic scatter by the final state particles. As stated before, the final state of an inelastic scatter in Geant is determined by the results of a simulation of a model -- in this case, the Bertini Cascade model. Delving into the underlying parameters of this Cascade model is currently outside of the scope of this work. Instead, we opt for a post-hoc treatment of the Cascade, and use the fractional populations of final states as the variable parameters. The fractional populations are found by running the Cascade model multiple times and finding the average results. This is then multiplied by the inelastic cross section. An example of this is found in Figure \ref{fig:cascade_xsecs}.

\begin{figure}[htpb]
	\centering
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Demonstration/frac}.pdf}
	\end{subfigure}	
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Demonstration/exclusive}.pdf}
	\end{subfigure}
	\caption{Left: $\pi^+$ -- Carbon Cascade Results, Right: Exclusive Cross Sections. Extracted from Geant4 version 10.3.p03}\label{fig:cascade_xsecs}
\end{figure}
First, we determine the nominal values for the exclusive cross sections ($\sigma_{i}$ for a specific final state). These will sum to a value equal to the total inelastic cross section $\sigma_{inel} = \sum\limits_{i}\sigma_{i}$.  User-defined variations are used to create a set of varied exclusive cross sections $\sigma_{i}'$ and a varied total cross section $\sigma_{inel}'$. In effect, the exclusive and total cross section have associated variation factors as such: $c_{inel}\sigma_{inel}  = \sum\limits_{i} c_{i} \sigma_{i}$. 

From here, the total cross section variation, $c_{inel}$, is used to vary the nominal simulation according to the technique described in Section \ref{subsec:inel_weights}. Events ending in a specific exclusive channel $i$ are given an additional weight $W_{i} = \frac{c_i}{c_{inel}}$. The presence of $c_{inel}$ in the denominator is due to the event already being weighted as an inelastic interaction. 

\section{Uncertainty Estimation -- Fitting}
For now, the inelastic interactions are only considered for uncertainty estimation. The uncertainty is estimated by separately varying the total inelastic and exclusive cross sections and fitting these to data. There are no tunable parameters that vary the inelastic cross section or the results of the Cascade which are available to users. Because of this, the total inelastic and exclusive cross sections are varied by creating overlayed variations that change their normalizations. Currently, the parameters in the fit are flat variations over ranges of momenta.

The results of the fit are the best fit values of the parameters defining the variations for specific ranges of momenta, and the associated covariance matrix. These results allow users to effectively change the results of some Geant4 simulation to match the best fit, as well as providing information to propagate the error on the cross sections\footnote{This can be done by producing correlated throws of the fit parameters, and is demonstrated in Section \ref{ssec:prop_demo}}.

\section{Usage Example}\label{sec:Demo}
This section provides an example of how this software could be used within an analysis. It starts with a demonstration on how to produce Geant4's nominal predictions for $\pi^+$ cross sections with a Carbon target, then uses this prediction in a fit to carbon data. The output of the fit is then used to propagate the uncertainties to some simulation observable, where the best-fit values of the parameters and their covariance matrix are used to produce parameter throws. These ensembles of thrown values are used to produce multiple reweightings of a simulation of pions in a volume of carbon to investigate the resulting variations in observables.

Note: all FCL files will be shown in detail in Appendix \ref{app:Demonstration_FHICL}
\subsection{Producing Predictions}
The first step is to produce the macroscopic $\pi^+$ - C cross section prediction. This is done using 

\begin{lstlisting}
G4CrossSection -c cross_section.fcl 
\end{lstlisting}

This produces a file called ``C$\_$PiPlus$\_$cross$\_$section.root". In this file is the total inelastic cross section which will be combined with the cascade fractions to produce exclusive cross sections. The inelastic cross section is shown in Figure \ref{fig:carbon_inel}
\begin{figure}[htpb]
	\centering
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Demonstration/carbon_inel}.pdf}
	\end{subfigure}
	\caption{$\pi^+$ -- Carbon Inelastic Cross Section}\label{fig:carbon_inel}
\end{figure}	

\begin{figure}[htpb]
	\centering
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Demonstration/frac}.pdf}
	\end{subfigure}	
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Demonstration/exclusive}.pdf}
	\end{subfigure}
	\caption{Left: $\pi^+$ -- Carbon Cascade Results, Right: Exclusive Cross Sections. Extracted from Geant4 version 10.3.p03}\label{fig:cascade_xsecs_2}
\end{figure}

Next, the predictions for the average results of the Bertini Cascade for $\pi^+$ impinging on Carbon are produced. This is done using \textbf{G4PiCascade}. As noted in \ref{note:G4PiCascade}, the time to run the cascade increases with incoming momentum, so this step is done in parallel by running the following commands:

\begin{lstlisting}
G4PiCascade -c C_PiPlus_cascade.fcl
\end{lstlisting}
\begin{lstlisting}
G4PiCascade -c C_PiPlus_cascade.fcl -o C_PiPlus_cascade_med.root --ND 49 --low 1010 --high 1500
\end{lstlisting}
\begin{lstlisting}
G4PiCascade -c C_PiPlus_cascade.fcl -o C_PiPlus_cascade_high.root --ND 49 --low 1510 --high 2000
\end{lstlisting}

Each of these produce root files containing the fraction of times the cascade ends in specific final states, over the range given in the FHiCL file or arguments. These are then stitched together using the following command:

\begin{lstlisting}
python stitch_results.py C_PiPlus_cascade.root C_PiPlus_cascade_low.root,C_PiPlus_cascade_med.root,C_PiPlus_cascade_high.root
\end{lstlisting}

These are multiplied by the total inelastic cross section to determine the exclusive cross sections. The cascade results and resulting exclusive cross 
sections are shown in Figure \ref{fig:cascade_xsecs_2}.

\subsection{Doing a Fit}\label{ssec:Fit}
Now that the predictions have been produced, they can be used in a fit to data. For this fit, 5 parameters were chosen. These are:

\begin{center}\label{ref:parameters}
  \begin{tabular}{| c | c | c |}
  \hline
  \textbf{Name} & \textbf{Channel} & \textbf{Momentum Range}  \\
  \hline
  \hline
  fReacLow & Reactive & (10.,200.) \\ 
  \hline
  fReacHigh & Reactive & (700., 2000.) \\
  \hline	
  fAbs & Absorption & (200., 700.) \\
  \hline  
  fCex & Charge Exchange & (200., 700.) \\
  \hline
  fInel & Inel/Quasi-elastic & (200., 700.) \\
  \hline
  \end{tabular}
\end{center}
Note: The parameters in the Reactive channel vary the total inelastic cross section (all exclusive cross sections are scaled by the same amount), while the parameters for the other channels scale only their own cross section.

The fit is performed by using the following command:
\begin{lstlisting}
Fitter -c C_fit.fcl
\end{lstlisting}
Again, the FHiCL files used for this are displayed in Appendix \ref{app:Demonstration_FHICL}, and the data is listed in \ref{app:Data_refs}.

The resulting best-fit values of the parameters (with their $\pm 1 \sigma$ error bars), and the covariance matrix are shown in Figure \ref{fig:fit_results}. These are used to produce $\pm 1 \sigma$ bands on the predictions, as shown in Figure \ref{fig:variations}
\begin{figure}[htpb]
	\centering
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Demonstration/pars}.pdf}
	\end{subfigure}	
	~
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Demonstration/cov}.pdf}
	\end{subfigure}
	\caption{Left: Fit Parameter Best Fit Values and $\pm 1 \sigma$ error bars, Right: Covariance Matrix}\label{fig:fit_results}
\end{figure}

\begin{figure}[htpb]
	\centering
	\begin{subfigure}[t!]{.3\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Demonstration/reac}.pdf}
	\end{subfigure}	
	~
	\begin{subfigure}[t!]{.3\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Demonstration/abs}.pdf}
	\end{subfigure}
	~
	\begin{subfigure}[t!]{.3\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Demonstration/cex}.pdf}
	\end{subfigure}
		
	\begin{subfigure}[t!]{.3\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Demonstration/abscx}.pdf}
	\end{subfigure}
	~
	\begin{subfigure}[t!]{.3\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Demonstration/inel}.pdf}
	\end{subfigure}
	\caption{$\pm 1 \sigma$ error bands}\label{fig:variations}
\end{figure}
\newpage

\subsection{Propagating Errors}\label{ssec:prop_demo}
The results of the fit can be used to produce sets of cross section variations, which are then applied to simulated Geant4. Using the class \textbf{G4ThrowManager}, a set of correlated throws of the fit parameters are used to build cross section variations. These cross section variations are applied to simulated pion tracks to produce sets of weights. 

For this example, a set of $\pi^+$ were simulated within a LArIAT sized\footnote{40cm x 47cm x 97cm} box of Carbon. The simulation results (stored in the root file C$\_$sim.root) were provided along with fit results to the reweighting \& parameter throwing application as follows:

\begin{lstlisting}
G4ThrowReweight -c throw_reweight.fcl
\end{lstlisting}\footnote{See Appendix \ref{app:Demonstration_FHICL}}

This produces a flat-tree file, where each entry in the tree represents a primary pion track. The branches include various observables, as well as a vector of weights resulting from the thrown parameters. These weights can be used to produce error bands on an observable of the simulation -- in this example: the length of pions undergoing an inelastic interaction. For each set of variations, the length of every interacting pion is binned with the weight corresponding to the thrown parameters. This produces histograms of the track length for each variation set. 

The histograms are looped through, and the systematic uncertainty is produced for each bin $j$:
\begin{equation}\label{eq:syst_uncertainty}
\sigma_j = \sqrt{\frac{1}{N} \sum\limits_i^N (\nu_j - n_{ij})^2}
\end{equation}
where N is the number of histograms/throws, $\nu_j$ is the best fit value for bin $j$, and $n_{ij}$ is the value of bin $j$ in histogram $i$.

Figure \ref{fig:error_prop} shows the results of this procedure.
\begin{figure}[htpb]
	\centering
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Demonstration/len_throws}.pdf}
	\end{subfigure}
	\caption{Track length of interacting pions in a box of Carbon. Blue shows the nominal prediction, the red histograms are produced using 100 variations of the fit parameters, black is the best fit value of the parameters with error bars comprised of statistical and systematic uncertainty (see Equation \ref{eq:syst_uncertainty}).}\label{fig:error_prop}
\end{figure}



\section{Software}

\subsection{Obtaining The Software}

The source code can be retrieved from \href{https://github.com/calcuttj/GeantReweight}{this repository}.

\subsection{Building The Software}

The software is built using CMake\footnote{Minimum CMake version is 3.1}, and requires an installation of both ROOT and Geant4. The ROOT installation will be accessed if its setup file has been sourced\footnote{The environment variable \textbf{ROOTSYS} will be accessed by cmake.}. The Geant4 installation will be specified using the cmake option -DGeant4$\_$DIR. To build, make a build directory adjacent to the GeantReweight top directory (let's call it "GeantReweight-build"). An install directory will be created during the cmake stage at the user's choice of location (using cmake option -DCMAKE$\_$INSTALL$\_$PREFIX). For this example, it will be called GeantReweight-install. Enter the build directory and execute:
\begin{lstlisting}
cmake -DCMAKE_INSTALL_PREFIX=/full/path/to/GeantReweight-install -DGeant4_DIR=/full/path/to/external/geant4-install/lib64/Geant4-<version>/ relative/path/to/GeantReweight/
\end{lstlisting}

If this is successful, the code can now be compiled using:
\begin{lstlisting}
make install -j<N cores>
\end{lstlisting}

\subsection{Software Overview}

GeantReweight consists of several base packages:
\begin{itemize}
	\item \textbf{FitterBase} -- Handles the fitting of Geant's predictions for the total and exclusive cross sections to external data sets.
	\item \textbf{ReweightBase} -- Handles the reweighting of Geant simulation output
	\item \textbf{PredictionBase} -- Produces root files that store the nominal exclusive and inclusive cross sections. These are used by FitterBase and ReweightBase. 
	\item \textbf{PropBase} -- Handles producing throws using output from FitterBase.
	\item \textbf{G4Sim} -- This is a simple, custom simulation package used for producing Geant4 simulation results.
\end{itemize}

\subsection{FitterBase}
The Fitting portion of the software takes in ROOT TGraphs representing the predictions for the inclusive and exclusive cross sections and fits these to data from various experiments.

\subsubsection{G4ReweightFitter}
An instance of the class \textbf{G4ReweightFitter} is created for each experiment/data set. The experiments are separated by probe ($\pi^+$ or $\pi^-$) and nuclear target. To configure, the user provides the following:
\begin{itemize}
	\item Name -- Name of the experiment.
	\item Type -- Represents the target and probe.
	\item Data File -- The location of the ROOT file associated to this data set.
	\item Graphs -- Set of graph names in the ROOT file and their cut types (absorption, charge exchange, etc.).
\end{itemize}

After creating an instance of \textbf{G4ReweightFitter} for an experiment and pointing it to data, the GetMCFromCurves method is used to produce varied predictions given nominal  Geant predictions and a set of user defined parameters (scaling factors for the exclusive channels and the total cross section). Once this is called, the DoFit method will produce the $\chi^2$ value between the data and varied predictions defined as: 

\begin{equation}
\chi^2_{i} = \sum\limits_j^{n_i} \frac{1}{n_i}\left(\frac{\sigma_j^{Data} - \sigma_j^{Geant}}{\Delta\sigma_j^{Data}}\right)^2
\end{equation}

Here, $n_i$ is the number of data points in set $i$, $\sigma^{Data}$ and $\sigma^{Geant}$ are the cross section values from the data and varied Geant respectively. $\Delta\sigma^{Data}$ is the error on the measurement. 

\subsubsection{DUETFitter}
A special version of the \textbf{G4ReweightFitter} class exists for data from the DUET experiment. Unlike the other data included in this project, this data was published along with correlations between the data points for its measurements.CITE The \textbf{DUETFitter} class is derived from \textbf{G4ReweightFitter}, and has its own versions of the constructor, SaveData, and DoFit methods to account for the correlations. The $\chi^2$ produced by DoFit is defined as:

\begin{equation}
\chi^2_{DUET} = \sum\limits_{i,j}^{10}(\sigma^{DUET}_i - \sigma^{Geant}_i)(V_{ij}^{-1})(\sigma^{DUET}_j - \sigma^{Geant}_j)
\end{equation}

Here, $\sigma^{DUET}$ and $\sigma^{Geant}$ are the cross sections from the DUET measurement and the varied Geant prediction. $V_{ij}$ is the DUET correlation matrix.

\subsubsection{G4ReweightFitManager} 

The fit is managed by the \textbf{G4ReweightFitManager} class. The user provides it a set of fit parameters which define the variations to be applied to the Geant predictions. It also defines the set of \textbf{G4ReweightFitter}s to be fit to nominal predictions. The manager calculates the number of degrees of freedom in the fit by using the GetNDOF method from \textbf{G4ReweightFitter}s\footnote{Note: for most of the experiments in the fit, the NDOF is 1 (each are treated as uncorrelated points in the fit). However, DUET provides 10 degrees of freedom (one for each correlated data point).}, summing this, and then subtracting the number of parameters defined for the fit. After defining the experiments to be fit, it creates an instance of a ROOT Minimizer. (MENTION THAT IT'S MIGRAD?) At this point, it either performs the fit with the Minimizer, or runs scans of the fit's $\chi^2$ depending on user input. If the fit is successful at finding a minimum, the manager also draws fit results. 

\subsubsection{Fitter Output}

Once the fit is performed, a ROOT file is saved containing the following:
\begin{itemize}
	\item A histogram of the best fit values and 1 dimensional errors on the parameters.
	\item The fit's resulting covariance matrix.
	\item A tree containing sets of parameter values and their associated $\chi^2$. If the scanning option was chosen, the user can use this tree to draw the results of the scans.
	\item A directory (Data) that holds all of the data used within the fit.
	\item A directory (Fit) that holds:
	\begin{itemize}
		\item The minimum $\chi^2$ value.
		\item A directory for each type (probe, nucleus combination) of experiment containing a set of TCanvas objects. There is one TCanvas for each channel (Reactive, Absorption, etc.) included in the fit for that type of experiment. These display the nominal prediction, best fit, and $\pm 1\sigma$ error bands along with all  data for that experiment type and channel.
	\end{itemize}
    \item If the user configures the manager to do so, a directory is created for each set of parameter values. This directory contains the resulting varied Geant predictions which were used to fit to that experiment's data.
\end{itemize}

\subsubsection{How To Run A Fit}\label{sssec:HowToFit}
The Fitter is configured via FHiCL(CITE). The following is a list of options that are passed to the executable:
\begin{itemize}
	\item OutputFile -- Name of the output file. This can be overridden with the command line option ``-o  filename.root".
	\item FitScan -- Tells the Fitter to run a scan over values of the fit parameters and output the resulting $\chi^2$.
	\item Save -- Tells the Fitter to save a directory for each set of parameter values.
	\item Sets -- A list of FHiCL parameter sets that define where the \textbf{G4ReweightFitters} get the nominal predictions based on the type (probe and nucleus) of the experiment. These have the structure of:
	\begin{itemize}
		\item Name -- What the set is called. This will be referenced by the experiments to access the corresponding predictions.
		\item File -- Location of the file containing the nominal total inelastic cross section from Geant. This is produced by \textbf{G4PiCascade} in \textbf{PredictionBase} (see \ref{sub:PredictionBase}). 
		\item FSFile -- Location of the file containing the nominal exclusive channel rates from Geant. This is produced by \textbf{G4CrossSection} in \textbf{PredictionBase} (see \ref{sub:PredictionBase}). 
	\end{itemize}
	\item Experiments -- A list of FHiCL parameter sets defining the individual experiments used within the fit. These have the structure of:
	\begin{itemize}
		\item Name -- Name of the experiment.
		\item Graphs -- A table relating the exclusive channels (reac, abs, cex, abscx, inel, dcex, prod) to their name in the data file.
		\item Data -- Location of the file containing the data for this experiment. 
		\item Type -- Probe and nuclear target. Used to relate experiments to the Geant predictions defined in the Sets parameters above.
	\end{itemize}
	\item ParameterSets -- A list of FHiCL parameter sets defining the fit parameters. These have the structure of:
	\begin{itemize}
		\item Name -- Parameter name.		
		\item Cut -- Which exclusive channel will this be applied to (reac, abs, cex, inel, prod, dcex).
		\item Range -- What momentum values this encompasses.
		\item Nominal -- Starting value of the fit for this parameter. 
    \end{itemize}	 
    
    \item IncludeDUET -- Tells the manager to create and include an instance of\textbf{DUETFitter}.
    \item DUETDataFile -- Tells the \textbf{DUETFitter} where its data is.
    \item MaxCalls -- ROOT Minimizer option: max number of calls in the fit.
    \item Tolerance -- ROOT Minimizer option:
    \item UpperLimit -- ROOT Minimizer option: Maximum value any parameter can take.
    \item LowerLimt -- ROOT Minimizer option: Minimum value any parameter can take.
\end{itemize}

An example of a full set of FHiCL parameters can be found in Appendix \ref{app:Fitter_FHiCL}.

Once these are set, the user can execute the Fitter using

\begin{lstlisting}
Fitter -c configuration.fcl
\end{lstlisting}

\subsection{ReweightBase}\label{ssec:ReweightBase}
This portion of the software includes classes that users access to interface with their Geant  simulation output, and a class that handles reweighting. Similar to Geant's simulation technique, the information is handled as track-like and step-like objects: \textbf{G4ReweightTraj} and \textbf{G4ReweightStep }respectively.

\subsubsection{G4ReweightStep}
This class contains information taken at the level of a step in Geant:
\begin{itemize}
	\item Track ID.
	\item Particle species (PDG code).
	\item Momentum before and after the step occurs.
	\item Position before and after the step.
	\item Which process occurred at the end of the step.
\end{itemize}

The class is not very complex, as it is just used to hold information related to one part of a \textbf{G4ReweightTraj}.

\subsubsection{G4ReweightTraj}
This class represents information taken at the level of a track within Geant and is the main reweightable object. It contains the following information:
\begin{itemize}
	\item Track ID.
	\item Particle species (PDG code).
	\item Track ID of parent particle.
	\item The set of steps forming the track.
	\item Pointer to parent particle \textbf{G4ReweightTraj}.
	\item Vector of pointers to daughter particle \textbf{G4ReweightTraj}.
	\item Vector of weights (these are created by the class that handles reweighting).
\end{itemize}

\subsubsection{G4Reweighter}
This class handles the reweighting. It is given a set of nominal exclusive and total inelastic cross sections, as well as variations to the individual exclusive channels. It then takes a \textbf{G4ReweightTraj} and computes a weight according to the scheme described in Sections \ref{subsec:inel_weights} and \ref{subsec:fs_rw}.

\subsection{PredictionBase}\label{sub:PredictionBase}
This portion of the software provides the nominal Geant predictions for the fitting and reweighting portions of the software. It is split up into 2 programs: \textbf{G4CrossSection} and \textbf{G4PiCascade}. 
\subsubsection{G4CrossSection}
This program accesses the inelastic and elastic cross sections for a specific hadronic proble and target material. These are the values that are used by Geant to determine \underline{when} an interaction occurs. The output is a root file containing TGraphs for the inelastic, elastic, and total (inelastic + elastic) cross sections as functions of both momentum and kinetic energy, as well as a TTree containing branches for momentum, kinetic energy, the inelastic cross section, and elastic cross section. 

The program is configurable via FHiCL, with optional command line arguments to override FHiCL options. The FHiCL options are:
\begin{itemize}
	\item Type -- The PDG code of the projectile. Currently supported are $\pi^{\pm}$ ($\pm211$) and protons ($2212$).
	\item Range -- The range of momentum used as input. 
	\item NDivisions -- Number of 'bins' used to extract the cross section. This is 1 less than the number of points in the output graphs.
	\item Verbose -- Controls how noisy the output of the program is.
	\item Outfile -- Location/name of output file.
	\item Material -- A FHiCL parameter set defining the target material. This has the following structure:
	\begin{itemize}
		\item Name -- What the material will be called.
		\item Z -- Atomic number of the material.
		\item Mass -- Atomic mass (units of $\textrm{g/mol}$).
		\item Density -- Density (units of $\textrm{g/cm}^3$).
	\end{itemize}
\end{itemize}

An example FHiCL file can be found in Appendix \ref{app:Prediction_FHICL}.

\subsubsection{How To Run G4CrossSection}
The usage for this program is: 

\begin{minipage}{\linewidth}
\begin{lstlisting}
Usage: ./G4CrossSection -c <xsec_config>.fcl [options]

Options: 
	-o     <output_file_override>.root
	--low  <range_low_value> 
	--high <range_high_value>
	--ND   <divisor_of_range> 
	-t     <probe type>
\end{lstlisting}
\end{minipage}


\subsubsection{G4PiCascade}
Inelastic interactions within Geant4 invoke the Bertini cascade. This model results places the hadronic projectile within the nuclear medium with its incoming kinematics. Then, the hadron starts to step through the medium, potentially interacting with other hadrons within the nucleus. When an interaction occurs, the results of that interaction proceed to traverse the nuclear medium. This goes on until all cascading particles either stop within the nuclear medium or are ejected. The ejected particles are then passed back to Geant's tracking manager to become ``live" particles within the detector. Because inelastic interactions occur this way, the concept of ``exclusive" interactions -- which are normally used by experiments -- is a slightly foreign one in this context. Thus, if one wants to know the exclusive cross sections, it is necessary to run the Bertini cascade many times to determine the fraction of inelastic scatters that end in a certain final state. The exclusive cross sections are thus defined as:
\begin{equation}
	\sigma_{i} = f_{i} * \sigma_{inel}
\end{equation}
where $f_i$ is the fraction of times the Bertini cascade ends in a specific final state $i$, and $\sigma_{inel}$ is the inelastic cross section (which would be extracted using the \textbf{G4CrossSection} program).

The \textbf{G4PiCascade} invokes the Bertini cascade a number of times across a momentum range for a specific projectile (currently only $\pi^{\pm}$) and nuclear target. For each call to the cascade, it looks at the outgoing particles to determine the final state. It detrmines the fraction of times this occurs for each step in momentum. Currently, the final state categories are defined as in Table \ref{tab:fates}.

Similar to \textbf{G4CrossSection}, this is configurable with FHiCL and optional command line arguments to override the FHiCL options. It shares the same FHiCL parameters as \textbf{G4CrossSection} with an additional parameter (NCascades) that determines the number of cascades done at each point in momentum space. 

An example FHiCL file can be found in Appendix \ref{app:Prediction_FHICL}.

\subsubsection{How To Run G4PiCascade}
The usage for this program is: 

\begin{minipage}{\linewidth}
\begin{lstlisting}
Usage: ./G4PiCascade -c <cascade_config>.fcl [options]

Options: 
	-o     <output_file_override>.root
	--low  <range_low_value> 
	--high <range_high_value> 
	--NC   <number_of_cascades_per_point> 
	--ND   <divisor_of_range> 
	-t     <probe type> 
\end{lstlisting}
\end{minipage}

\subsubsection{An Important Note on G4PiCascade}\label{note:G4PiCascade}
As projectile momentum increases, the Bertini cascade takes longer to run on average due to the increased number of interactions and cascading particles within the cascade. Because of this, it is suggested to break up the momentum range and run multiple iterations of \textbf{G4PiCascade} in parallel, and then stitch the results together using the python script \textbf{stitch$\_$results.py}. This appends the TGraphs together and saves them in another ROOT file. To use this script, type:


\begin{minipage}{\linewidth}
\begin{lstlisting}
python stitch_results.py OutputFile.root f1.root,f2.root,...
\end{lstlisting}
\end{minipage}
The second argument is a comma-separated list of input files which should be given in increasing order of momentum range.
\subsection{PropBase}
This portion of the software is used to take the output from a fit, then produce throws of the fit parameters to the resulting covariance matrix. This is handled by the class \textbf{G4ParameterMaker}. The class, \textbf{G4ParameterMaker}, is a utility class which takes in a set of FHiCL parameters to create cross section variations which can be used within the fit software and when reweighting.

\subsubsection{G4ThrowManager}
This class is used to create correlated sets of parameter throws according to the results of a fit. The set of thrown parameter values, $\overrightarrow{v}$, is equal to
\begin{equation}
\vec{v} = \vec{v}_0 + \textbf{L} \cdot \vec{r}
\end{equation}
where $\vec{v}_0$ is the best-fit values of the parameters, $\textbf{L}$ is the Cholesky decomposition of the fit's covariance matrix, and $\vec{r}$ is a set of Gaussian random numbers with a mean of 0 and variance of 1.
 
\subsection{G4Sim}
This portion of the software is used to produce a set of Geant4 simulation for internal testing. Two apps are provided: \textbf{G4Sim} and \textbf{G4Thin}. The tracking volume of \textbf{G4Sim} is a LArIAT-sized box\footnote{40cm x 47cm x 97cm}, while the volume in \textbf{G4Thin} is a .5cm tall cylinder used for thin-target simulations. The material is configured via FHiCL by providing a name for the material, the material's atomic number, its molar mass, and some density. The species, spatial distribution, energy spectrum, and number of incident particles is provided via normal Geant4 macros. The simulations can be run with the following command.

\begin{lstlisting}
G4Sim -c geant4_macro.mac -o output.root -m material.fcl
\end{lstlisting}
One can replace \textbf{G4Sim} in the command with \textbf{G4Thin} to run the thin-target simulation.

\section{Testing and Validation - Thin Target Scattering}
A simulation of pions scattering off a thin target of Carbon -- created using Geant4 version 10.3.p03 -- was used to extract the pion-Carbon inelastic scattering cross section. 
This was checked against Geant4's predictions for the cross section as extracted by the \textbf{G4CrossSection} program.
The thin target was a disk of .5cm in thickness and 1.5m in radius. The rate of inelastic scatters ($N_{inel}$)and the number of incident pions ($N_{inc}$) were used to determine the total inelastic cross section: 

\begin{equation}\label{ref:reactive_xsec}
\sigma_{reac} = \frac{N_{inel}}{N_{inc}}\frac{1}{Nx}
\end{equation}
Here, $N$ is the number density of the material, and $x$ is the thickness of the target (.5 cm).

\subsection{Flat Variations}

A flat variation (a scaling factor of 1.5) to the inelastic cross section was applied to Geant4, and was compared to a reweighting of the nominal simulation. Figure \ref{fig:flat_validation} shows this comparison.

\begin{figure}[htpb]
	\centering
	\begin{subfigure}[t!]{.35\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Validation/xsec_flat}.pdf}
	\end{subfigure}	
	~
	\begin{subfigure}[t!]{.35\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Validation/ratio_flat}.pdf}
	\end{subfigure}
	\caption{Left: The $\pi^+ -$ C inelastic cross section extracted from a thin target simulation.``Weighted" refers to a reweighting applied to the nominal simulation. Right: Ratio comparing reweighting of Geant4 to varying ``by-hand."}\label{fig:flat_validation}
\end{figure}

\subsection{Binned Variations}
Similarly, multiple variations across the momentum range were tested. The comparison between the nominal, varied, and weighted simulation are shown in \ref{fig:binned_validation}, along with the variation used for this study.

\begin{figure}[htpb]
	\centering
	\begin{subfigure}[t!]{.35\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Validation/xsec_binned}.pdf}
	\end{subfigure}	
	~
	\begin{subfigure}[t!]{.35\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Validation/ratio_binned}.pdf}
	\end{subfigure}
	
	\begin{subfigure}[t!]{.35\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Validation/binned_variation}.pdf}
	\end{subfigure}	
	\caption{Left: The $\pi^+ -$ C inelastic cross section extracted from a thin target simulation.``Weighted" refers to a reweighting applied to the nominal simulation. Right: Ratio comparing reweighting of Geant4 to varying ``by-hand." Bottom: The variations applied to the simulation.}\label{fig:binned_validation}
\end{figure}
%\newpage

\section{Testing and Validation - Scattering in a Volume}
In addition to simulated scattering off a thin target, pions were simulated within a LArIAT-sized\footnote{40cm x 47cm x 90cm} volume of Carbon -- again using Geant4 version 10.3.p03. Variations were applied to the Geant4 cross section by-hand and through reweighting. The effects on various observables -- such as the length of the pion tracks and the rate of events ending in an inelastic scatter -- were compared between varying and reweighting.


\subsection{Flat Variations}

\begin{figure}[htpb]
	\centering
	\begin{subfigure}[t!]{.35\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Validation/len_flat_sim}.pdf}
	\end{subfigure}	
	~
	\begin{subfigure}[t!]{.35\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Validation/len_ratio_flat_sim}.pdf}
	\end{subfigure}
	\caption{Left: Track length distribution of pions within a volume of Carbon. ``Weighted" refers to reweighting of the nominal simulation. Right: Ratio comparing reweighting of Geant4 to varying ``by-hand."}\label{fig:len_sim_flat_validation}
\end{figure}

\begin{figure}[htpb]
	\centering
	\begin{subfigure}[t!]{.35\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Validation/int_flat_sim}.pdf}
	\end{subfigure}	
	~
	\begin{subfigure}[t!]{.35\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Validation/int_ratio_flat_sim}.pdf}
	\end{subfigure}
	\caption{Left: Fraction of pions ending in an inelastic scatter within a volume of Carbon. ``Weighted" refers to reweighting of the nominal simulation. Right: Ratio comparing reweighting of Geant4 to varying ``by-hand."}\label{fig:int_sim_flat_validation}
\end{figure}

\subsection{Binned Variations}
Again, multiple variations across the momentum range were tested.

\begin{figure}[htpb]
	\centering
	\begin{subfigure}[t!]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Validation/new_binned_variation}.pdf}
	\end{subfigure}	
	\caption{Variations applied to the Geant4 cross section. Note that this is different to the variations applied to the thin-target section.}\label{fig:new_binned_variation}
\end{figure}

\begin{figure}[htpb]
	\centering
	\begin{subfigure}[t!]{.35\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Validation/len_binned_sim}.pdf}
	\end{subfigure}	
	~
	\begin{subfigure}[t!]{.35\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Validation/len_ratio_binned_sim}.pdf}
	\end{subfigure}
	\caption{Left: Track length distribution of pions within a volume of Carbon. ``Weighted" refers to reweighting of the nominal simulation. Right: Ratio comparing reweighting of Geant4 to varying ``by-hand."}\label{fig:len_sim_binned_validation}
\end{figure}

\begin{figure}[htpb]
	\centering
	\begin{subfigure}[t!]{.35\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Validation/int_binned_sim}.pdf}
	\end{subfigure}	
	~
	\begin{subfigure}[t!]{.35\textwidth}
		\centering
		\includegraphics[width=\textwidth]{{/home/jake/Validation/int_ratio_binned_sim}.pdf}
	\end{subfigure}
	\caption{Left: Fraction of pions ending in an inelastic scatter within a volume of Carbon. ``Weighted" refers to reweighting of the nominal simulation. Right: Ratio comparing reweighting of Geant4 to varying ``by-hand."}\label{fig:int_sim_binned_validation}
\end{figure}


\appendix

\section{Fitter FHiCL Example}\label{app:Fitter_FHiCL}

Below is an example of a FHiCL configuration that can be supplied to the Fitter. Note that this example employs FHiCL use of prologs to allow parameters to be taken from multiple files. The explanation of all fields can be found in \ref{ssec:ReweightBase}\\

fit.fcl:
\begin{lstlisting}
  1 #include "sets.fcl"
  2 #include "parameters.fcl"
  3 #include "C_experiments.fcl"
  4 
  5 OutputFile: "example.root"
  6 FitScan: false
  7 Save: false
  8 
  9 #Taken from sets.fcl
 10 Sets: [
 11   @local::C_PiPlus
 12 ]
 13 
 14 #Taken from C_experiments.fcl
 15 Experiments: [ 
 16   @sequence::C_experiments
 17 ]
 18 
 19 #Taken from parameters.fcl
 20 ParameterSet: @local::TheParameters
 21 
 22 IncludeDUET: true
 23 DUETDataFile: "/path/to/DUET.root"
 24 
 25 MaxCalls: 500
 26 Tolerance: 1.e-5
 27 UpperLimit: 2.0
 28 LowerLimit: .5

\end{lstlisting}
\newpage

sets.fcl:
\begin{lstlisting}
  1 BEGIN_PROLOG
  2 
  3 C_PiPlus: {
  4 
  5   Name: "C_PiPlus"
  6 
  7   File: "/path/to/C_PiPlus_cross_section.root"
  8 
  9   FSFile: "/path/to/C_PiPlus_cascade.root"
 10 }
 11 
 12 END_PROLOG
\end{lstlisting}
\newpage

experiments.fcl:
\begin{lstlisting}
  1 BEGIN_PROLOG
  2 
  3 C_experiments: [
  4   {
  5     Name:    "Experiment1_C_PiPlus"
  6     Graphs:  [
  7       ["reac", "C_xsec_reac_piplus"]
  8     ]
  9 
 10     Data:   "/path/to/Experiment1.root"
 11 
 12     Type:   "C_PiPlus"
 13   },
 14 
 15   {
 16     Name:    "Experiment2_C_PiPlus"
 17 
 18     Graphs:  [
 19       ["inel", "C_xsec_inel_piplus"],
 20       ["abscx", "C_xsec_abscx_piplus"]
 21     ]
 22     Data:   "/path/to/Experiment1.root"
 23 
 24     Type:   "C_PiPlus"
 25   }
 26
 27 END_PROLOG
\end{lstlisting}
\newpage 

parameters.fcl:
\begin{lstlisting}
  1 BEGIN_PROLOG
  2 
  3 TheParameters: [                          
  4   {                                       
  5     Name:       "fReacLow"                
  6     Cut:        "reac"                    
  7     Range:      [10., 200.]               
  8     Nominal:    1.0                       
  9   },                                      
 10   {                                       
 11     Name:       "fReacLow"                
 12     Cut:        "reac"                    
 13     Name:       "fReacHigh"               
 14     Range:      [700., 2005.]             
 15   },                                      
 16                                           
 17   {                                       
 18     Cut:        "abs"                     
 19     Name:       "fAbs"                    
 20     Range:      [200.0, 700.00]           
 21   },                                      
 22                                           
 23   {                                       
 24     Cut:        "cex"                     
 25     Name:       "fCex"                    
 26     Range:      [200.0, 700.00]           
 27   },                                      
 28                                           
 29   {                                       
 30     Cut:        "inel"                    
 31     Name:       "fInel"                   
 32     Range:      [200.0, 700.00]           
 33   }
 35 }
 36 END_PROLOG
\end{lstlisting}

\newpage

\section{Example FHiCLs for G4CrossSection and G4PiCascade}\label{app:Prediction_FHICL}
cross$\_$section.fcl:
\begin{lstlisting}
  1 #include "material.fcl"
  2 Type: 211
  3 Range: [10., 8000.]
  4 NDivisions: 7989
  5 Verbose: "true"
  6 Outfile: "CrossSectionOutput.root"
  7 
  8 Material: @local::LAr
\end{lstlisting}

cascade.fcl:
\begin{lstlisting}
  1 #include "material.fcl"
  2 Type: 211
  3 NCascades: 10000
  4 Range: [50., 600.]
  5 #NDivisions: 55
  6 NDivisions: 1
  7 Outfile: "CascadeOutput.root"
  8 
  9 Material: @local::LAr
\end{lstlisting}

material.fcl:
\begin{lstlisting}
  1 BEGIN_PROLOG
  2 
  3 LAr: {
  4   Name: "liquidArgon"
  5   Z:    18
  6   Mass: 39.95
  7   Density: 1.390
  8 }
  9 
 10 END_PROLOG
\end{lstlisting}

Both cross$\_$section.fcl and cascade.fcl can use material.fcl.

\newpage

\section{Example FHiCLs for Demonstration}\label{app:Demonstration_FHICL}

\subsection{Prediction}

C$\_$PiPlus$\_$cross$\_$section.fcl:
\begin{lstlisting}
  1 #include "material.fcl"
  2 Type: 211
  3 Range: [10., 8000.]
  4 NDivisions: 7989
  5 Verbose: "true"
  6 Outfile: "C_PiPlus_cross_section.root.root"
  7 
  8 Material: @local::C
\end{lstlisting}

C$\_$PiPlus$\_$cascade.fcl:
\begin{lstlisting}
  1 #include "material.fcl"
  2 Type: 211
  3 NCascades: 100000
  4 Range: [10., 1000.]
  5 NDivisions: 95
  6 Outfile: "C_PiPlus_cascade_low.root"
  7 
  8 Material: @local::C
\end{lstlisting}

material.fcl:
\begin{lstlisting}
  1 BEGIN_PROLOG
  2 
  3 C: {
  4   Name: "graphite"
  5   Z:    12
  6   Mass: 12.01
  7   Density: 2.266
  8 }
  9 
 10 END_PROLOG
\end{lstlisting}

\subsection{Fitting}
C$\_$fit.fcl:
\begin{lstlisting}
  1 #include "sets.fcl"
  2 #include "parameters.fcl"
  3 #include "C_experiments.fcl"
  4 
  5 OutputFile: "C_PiPlus_fit.root"
  6 FitScan: false
  7 Save: false
  8 
  9 Sets: [
 10   @local::C_PiPlus,
 11 ]
 12 
 13 Experiments: [
 14   @sequence::C_experiments,
 15 ]
 16 
 17 ParameterSet: @local::TheParameters
 18 
 19 IncludeDUET: true
 20 DUETDataFile: "/path/to/DUET.root"
 21 
 22 MaxCalls: 500
 23 Tolerance: 1.e-5
 24 UpperLimit: 2.0
 25 LowerLimit: .5
\end{lstlisting}

sets.fcl:
\begin{lstlisting}
  1 BEGIN_PROLOG
  2 
  3 C_PiPlus: {
  4 
  5   Name: "C_PiPlus"
  6 
  7 
  8   File: "/path/to/C_PiPlus_cross_section.root"
  9 
 10 
 11   FSFile: "/path/to/C_PiPlus_cascade.root"
 12 }
 13 
 14 END_PROLOG
\end{lstlisting}

parameters.fcl: see \ref{app:Fitter_FHiCL}

C$\_$experiments.fcl: 
\begin{lstlisting}
  1 BEGIN_PROLOG
  2 
  3 C_experiments: [
  4   { 
  5     Name:    "Meirav_C_PiPlus"
  6     Graphs:  [ 
  7       ["reac", "C_xsec_reac_piplus"]
  8     ]
  9     
 10     Data:   "/path/to/Meirav.root"
 11 
 12     
 13     Type:   "C_PiPlus"
 14   },
 15 
 16   { 
 17     Name:   "Allardyce_C_PiPlus"
 18     Graphs: [ ["reac", "C_xsec_reac_piplus"] ]
 19     
 20     Data:   "/path/to/Allardyce.root"
 21     
 22     Type:   "C_PiPlus"
 23   },
 24 
 25   { 
 26     Name:   "Saunders_C_PiPlus"
 27     Graphs: [ ["reac", "C_xsec_reac_piplus"] ]
 28     
 29     Data:   "/path/to/Saunders.root"
 30     
 31     Type:   "C_PiPlus"
 32   },
 33 
 34   { 
 35     Name:   "Levenson_C_PiPlus"
 36     
 37     Graphs: [ ["inel", "C_xsec_inel_piplus"] ]
 38     
 39     Data:   "/path/to/Levenson.root"
 40 
 41     Type:   "C_PiPlus"
 42   },
 43 
 44   {
 45     Name:   "Jones_C_PiPlus"
 46     Graphs: [ ["inel", "C_xsec_inel_piplus"], ["cex", "C_xsec_cex_piplus"] ]
 47 
 48     Data:   "/path/to/Jones.root"
 49 
 50     Type:   "C_PiPlus"
 51   },
 52 
 53   {
 54     Name:   "Ashery_2173_C_PiPlus"
 55     Graphs: [ ["inel", "C_xsec_inel_piplus"], ["abscx", "C_xsec_abscx_piplus"] ]
 56 
 57     Data:   "/path/to/Ashery_2173.root"
 58 
 59     Type:   "C_PiPlus"
 60   },
 61 
 62   {
 63     Name:   "Ashery_946_C_PiPlus"
 64     Graphs: [ ["cex", "C_xsec_cex_piplus"] ]
 65 
 66     Data:   "/path/to/Ashery_946.root"
 67 
 68     Type:   "C_PiPlus"
 69   },
 70 
 71   {
 72     Name:   "Bellotti_C_PiPlus"
 73     Graphs: [ ["cex", "C_xsec_cex_piplus"], ["abs", "C_xsec_abs_piplus"]]
 74 
 75     Data:   "/path/to/Bellotti.root"
 76 
 77     Type:   "C_PiPlus"
 78   },
 79 
 80   {
 81     Name:   "Navon_C_PiPlus"
 82     Graphs: [ ["abscx", "C_xsec_abscx_piplus"]]
 83 
 84     Data:   "/path/to/Navon.root"
 85 
 86     Type:   "C_PiPlus"
 87   }
 88 ]
 89 
 90 END_PROLOG
\end{lstlisting}
\newpage
throw$\_$reweight.fcl:
\begin{lstlisting}
  1 #include "parameters.fcl"                                                                                                        
  2                                                                                                                                  
  3                                                                                                                                  
  4 OutputFile: "C_throw_rw.root"                                                                                                  
  5 InputFile:  "C_sim.root"                                          
  6 Fracs:      "C_PiPlus_cascade.root"                                                                                              
  7 XSec:       "C_PiPlus_cross_section.root"                                                                                        
  8 FitResults: "C_PiPlus_fit.root"                                                                                                  
  9                                                                                                                                  
 10 ParameterSet: @local::TheParameters                                                                                              
 11                                                                                                                                  
 12 nThrows: 100  
\end{lstlisting}
\newpage

\section{Summary of Data Used in Fit}\label{app:Data_refs}
The data used for the example fit in the demonstration (see section \ref{ssec:Fit}) is summarised in the following table. All data was taken from experiments measuring $\pi^+$ interacting on Carbon.
\begin{table}[htpb]
\begin{center}
  \begin{tabular}{| c | c |}
  \hline
  \textbf{Reference} & \textbf{Channel(s)}\\  
  \hline	
  \hline
  B. W. Allardyce \textit{et al.}\cite{Allardyce} & Reactive \\
  \hline
  D. Ashery \textit{et al.}\cite{Ashery_1} & Quasielastic, Absorption + Charge Exchange \\ 
  \hline
  D. Ashery \textit{et al.}\cite{Ashery_2} & Charge Exchange \\ 
  \hline
  E. Bellotti \textit{et al.}\cite{Bellotti_1} & Absorption \\ 
  \hline
  E. Bellotti \textit{et al.}\cite{Bellotti_2} & Charge Exchange \\ 
  \hline  
  C. J. Gelderloos \textit{et al.}\cite{Gelderloos} & Reactive \\
  \hline  
  M. K. Jones \textit{et al.}\cite{Jones} & Quasielastic, Charge Exchange \\ 
  \hline
  S. M. Levenson \textit{et al.}\cite{Levenson} & Quasielastic \\
  \hline
  O. Meirav \textit{et al.}\cite{Meirav} & Reactive \\
  \hline
  I. Navon \textit{et al.}\cite{Navon} & Absorption + Charge Exchange \\
  \hline
  E. S. Pinzon Guerra \textit{et al.}\cite{DUET} & Absorption, Charge Exchange \\
  \hline
  A. Saunders \textit{et al.}\cite{Saunders} & Reactive \\
  \hline  
  \end{tabular}
\end{center}
\caption{Data used in the demonstration fit}\label{tab:fit_data}
\end{table}

\begin{thebibliography}{12}

\bibitem{Allardyce}
B. W. Allardyce \textit{et al.}, Nuclear Physics A \textbf{209}, 1 (1973).
\bibitem{Ashery_1}
D. Ashery \textit{et al.}, Physical Review C \textbf{23}, 2173 (1981).
\bibitem{Ashery_2}
D. Ashery \textit{et al.}, Physical Review C \textbf{30}, 946 (1984).
\bibitem{Bellotti_1}
E. Bellotti, D. Cavalli, and C. Matteuzzi, Il Nuovo Cimento A (1965-1970) \textbf{18}, 75 (1973).
\bibitem{Bellotti_2}
E. Bellotti, S. Bonetti, D. Cavalli, and C. Matteuzzi, Il
Nuovo Cimento A (1965-1970) \textbf{14}, 567 (1973).
\bibitem{Gelderloos}
C. J. Gelderloos \textit{et al.}, Physical Review C \textbf{62}, 024612
(2000).
\bibitem{Jones}
M. K. Jones \textit{et al.}, Physical Review C \textbf{48}, 2800 (1993).
\bibitem{Levenson}
S. M. Levenson \textit{et al.}, Physical Review C \textbf{28}, 326 (1983).
\bibitem{Meirav}
O. Meirav, E. Friedman, R. R. Johnson, R. Olszewski,
and P. Weber, Phys. Rev. C \textbf{40}, 843 (1989).
\bibitem{Navon}
I. Navon \textit{et al.}, Physical Review C \textbf{28}, 2548 (1983).
\bibitem{DUET}
E. S. Pinzon Guerra \textit{et al.} (DUET Collaboration), Phys.
Rev. C \textbf{95}, 045203 (2017).
\bibitem{Saunders}
A. Saunders \textit{et al.}, Physical Review C \textbf{53}, 1745 (1996).
\end{thebibliography}

\end{document}




